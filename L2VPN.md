![vpws1](C:\Users\Administrator\Pictures\network\vpws1.png)

3.2通用L2VPN传输功能模块

所有L2VPN类型的网络必须在PE间的核心网中传输"帧"(frames)。PE1从CE1收到一帧，传输到PE2,再由PE2传输到CE2，本章我们讨论传输不同类型L2VPN链路中传输L2帧所必需的功能组件。

3.2.1Attachment Circuits

在任意类型的L2VPN网络中，一台CE设备都需要通过某种链路或虚拟链路接入一台PE设备，我们称之为“接入链路”(AC)。该术语使用相当普遍；接入链路(AC)可能是帧中继链路， ATM VPI/VCI，以太端口，VLAN，PPP物理层直连链路，L2TP隧道上的PPP会话，MPLS LSP(标签交换协议链路)等。CE设备可能是路由器，交换机，主机等等任意用户需要接入VPN的设备。AC负责将帧在CE和PE之间传输。

配置和维护AC的过程不再本文描述范围。

任意帧都会通过AC从CE传输到PE，然后到达另一端的AC从PE传输到CE。

“ingress AC”和”egress AC“分别指代帧的入和出链路，请注意这两个角色与具体的帧有关，且仅限于标明帧的传输方向。

一条"Pseudowire"(PW)存在于两台PE设备间，用于在PE之间传输帧，与之相对的AC则是在PE和CE之间传输帧。PW的详情请参[RFC3985]。

PEs负责建立和维护PW。PW的状态由其两端的PE维护。

PW可能是点对点的，多对点，多对多的。在本文所述框架中，点对点PW默认为双向的，点对多，和多对点则默认为单向的。多对多PW仅当收到帧的PE不需要知道该帧所对应的入AC的身份时使用。当需要广播时，点对多PW相当有用。

广播帧可能会被接收到它的PE复制并发送，所以广播帧中的信息可能会经过多条PW并从多个egress AC出去。

因此对于一个给定帧，一条PW和数条AC联结。若这些AC链路类型相同，则称PW提供了”homogeneous transport“ （同质传输？？），否则称为 "heterogeneous transport"（异质传输）。异质传输需要处理一些接入适配，至少有三种方法：

1.CE可能在本地处理。例如CE1通过ATM接入PE1，但CE2通过以太网接入PE2，那么CE1可根据RFC2684在ATM链路上收发以太帧，同时PE1需要相应的中断ATM链路，仅在PW上收发以太帧。

2.由PE之一来处理。例如，CE1通过ATM连到PE1，CE2通过帧中继连到PE2，PE1可能提供”ATM/FR“的接入转换功能。（即PW链路上传输的帧由某台PE来做对应AC链路的格式转换）

3.使用IPLS(IP分组标记交换)。在PW上传输IP数据报，由IP协议标准处理模块来负责帧格式的处理，但是需要两边PE协商好以避免一些L2链路敏感的IP协议相关处理。(不太懂........)

如果使用异质传输PW，那么PW的建立协议必须保证两端AC知道彼此的MTU，如果两端AC MTU不同，那么需要一些额外处理了：

-- PW不允许进入工作状态(come up)。

-- MTU较大的一端AC必须调整MTU为较小的那一端的值。

-- 两端必须协商好分片重组过程。

3.2.3. Forwarders(转发器)

PE1和PE2为同一台设备的情况需要谨慎处理。但我们并不在此讨论。

PE1收到一帧时，需要考虑转发往哪条PW，判断主要依据：

-- 入AC

-- 可能与二层帧头相关

-- 可能是(PE)维护的一些转发信息（我们现在的VPWS是根据帧里面的MAC地址？）

转发信息的维护与具体的VPN网络实例相关。



相似的，当PE2从某条PW收到一帧，它必须决定转发往哪条AC，判断依据如下：

-- 来源PW

-- 二层帧头

-- PE本身维护的信息

术语”forwarder“，转发器，表示用来决定转发路径的模块。不妨认为PW被绑在两端PE的转发器上。不同类型的L2VPN网络实现了不同的转发器。比如，一个forwarder可能仅绑定一条AC和一条PW(vpls)，不去考虑帧内容也不需要存储信息。也能绑定一条AC和多条PW，多个出AC。这样就需要根据2层帧信息判断转发到那条AC/PW。



3.2.4 隧道

一条PW由PE1与PE2之间的隧道承载，假定一条隧道可以承载任意条PW，唯一条件是PW在PE2终结。(不然PE2感知不到?)

但是并不要求PE1是所有PW的起点（因为L2VPN forwarder是直接处理的二层帧？所以不可能被其他协议拦截掉报文？），也不要求所有PW穿过相同的PE，只要数据帧穿过隧道到达PE2时，PE2能够建立它与特定PW的联系。

隧道的实现有大量的技术，唯一的要求是允许多条PW进行多路解码。(多条PW的报文在同一隧道传输，需要能够区分)，隧道可能是MPLS LSP（我们现在主要用的），L2TP tunnel, IPsec tunnels (IP分组隧道？？啥玩意)等等。通常这些隧道技术需要分装帧并附加标记字段用来多路解码。

如果PE1到PE2有多条隧道，那么根据PW和隧道的特殊标记来将特定的PW建立到特定的的隧道上是个不错的主意。例如，通过Qos标记，根据pw对Qos的要求和隧道的Qos指标进行分配。

虽然点对点PW是双向的，但是承载它的隧道并不一定是双向的，也不一定是点对点的。



3.2.5 封装

由于L2VPN数据包由PW承载，所以无论何处都应尽量使用标准PW分装格式和技术。（在IETF PWE3中阐明）

通常PW报文会被封装在承载他们的隧道的报文里，具体格式依隧道类型而定。

3.2.6 PW信令

建立和维护PW在本文大纲内，包括分发解码字段的值，即便该字段在隧道协议头上，而不属于PW协议内容。

点对点PW信令需要实现以下功能：

--多路解码符号的分发

由于多条PW可能由一条隧道承载，隧道协议必须为每一个PW分配一个值。这些值必须唯一且对应一条给定的隧道。通常隧道的出口选择demultiplexor 的值，并将他们分发给隧道的入口PE，这是PW建立过程中必要的一步。

通常情况下，在隧道的架构里，demultiplexor 字段是属于隧道协议的，而不是属于隧道承载的协议。因此，PW创建协议依赖于隧道的控制协议。

--在远端PE选择转发器

信令必须包含足够的信息，使远端PE能够依此选择转发往哪条PW。这部分信息被称为 "Remote Forwarder Selector” ，它可能指定了唯一一个forwarder，也可能指定了一组forwarder满足的属性。

--？？？？

> - Supporting pseudowire emulations.        
>
>   To the extent that a particular PW must emulate the signaling of        a particular Layer2 technology, the PW signaling must provide        the necessary functions.

--分发状态变化

PW应对其绑定的AC的状态变化做出响应反应，反之亦是。

--建立PW特性

两端PE支持的PW特性需要互相协商，信令需要实现其协商的手段。

综上所述，点对点PW信令必须传递足够的信息以使远端PE能够正确的处理PW与forwarder的绑定(即帧的分发)。一旦两台PE完成PW/forwarder的绑定，协商好demultiplexor 的值，那么pw就可以建立了。若对于特定的PW有部分PW特性需要处理或是状态信息需要传递，则可以通过demultiplexor 来标志彼此。

点对点PW的信令处理通常由两端的PE执行。

2.2.6.1 点对点信令

点对点信令功能有多种实现，包括：

--LDP（我们用的）

​	LDP [RFC3036]可用于PW信令的实现。这种信令在mpls承载的PW网络中使用。

-- L2TP（我们好像也用了）

​	L2TP[RFC2661]隧道上建立PW回话同样可以实现信令。

一对PE间建立一条控制连接来管理多条业务PW是可行的。

多对点方式的PW同样可以使用点对点的PW信令，因为远端PE(指的是多的那一边吧？)并不需要知道PW是多对点还是点对点(这里是说单向传输的情况吗？)

3.2.6.2 点对多信令

考虑如下条件：

-- 需要建立一组PW，每一个都有相同特性

-- 不需要用PW信令来传递PW状态变化

-- 组中PW可使用相同的远端forwarder selector值。

这些称为“环境条件”

假定通过某些机制，给定一组demultiplexor 的值，每台PE都可在其中选择唯一一个值，这称为"Demultiplexor Condition".（？？？） 相应的，假设我们要建立多对点PW而不是点对点PW，则称次为（多点条件）

如果：

​	-- 环境条件成立；并且

​	-- 以下两者满足一起：

​		*Demultiplexor Condition成立

​		* Multipoint Condition成立

那么对于一组给定的终结于egress PE1的PW，对于任意一条，PE1需要发送到ingress PE的信息是相同的，包括demultiplexor 的值(或值的范围)。

不须通过重复的与每一台ingress PE交互信令，而是广播(组播？)这些信令，或是通过一台"reflector" PE来分发这些信息，就可以完成PW的建立。

我们称实现这种技术的信令为点对多信令。



3.3 VPWS

